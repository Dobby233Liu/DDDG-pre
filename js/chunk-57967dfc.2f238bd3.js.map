{"version":3,"sources":["webpack:///./src/components/content-pack-builder/expression-builder/index.vue?7bf1","webpack:///./src/components/content-pack-builder/expression-builder/selection.vue?18a6","webpack:///./src/components/content-pack-builder/expression-builder/selector.vue?d800","webpack:///./src/components/content-pack-builder/expression-builder/index.vue","webpack:///./src/components/content-pack-builder/expression-builder/selection.vue","webpack:///./src/components/content-pack-builder/expression-builder/selection.vue?745c","webpack:///./src/components/content-pack-builder/expression-builder/selection.vue?e6b9","webpack:///./src/components/content-pack-builder/expression-builder/selector.vue","webpack:///./src/components/content-pack-builder/expression-builder/selector.vue?dddf","webpack:///./src/components/content-pack-builder/expression-builder/selector.vue?beaf","webpack:///./src/util/workBatch/index.ts","webpack:///./src/components/content-pack-builder/expression-builder/index.vue?99ea","webpack:///./src/components/content-pack-builder/expression-builder/index.vue?1870"],"names":["class","dragEnter","hideDt","headGroup","method","uploadsFinished","Math","round","batchRunner","percentage","normalizeName","name","downloadLink","to","listLink","ref","addByImageFile","verticalScrollRedirect","$refs","upload","click","type","multiple","addByUpload","addByUrl","uploadedExpressions","expression","idx","key","style","currentUploadedExpression","width","previewPoses","previewPoseIdx","height","pose","value","title","offsetX","offsetY","imagePatching","mask","label","addMask","addExtras","disabled","removeUploadedExpression","finishUpload","leave","icon","hasParts","availableHeadGroups","headgroup","images","preview","background","$emit","props","String","default","computed","this","map","i","join","render","__scopeId","runner","disposer","parallel","state","busy","error","completed","fullCount","pendingData","currentlyRunning","Set","resolveCurrentRun","rejectCurrentRun","returnData","remainingDisposers","runningDisposers","newData","reject","slice","length","Promise","resolve","restock","remainingCapacity","startOne","size","startDisposer","data","shift","undefined","add","isRunning","has","ret","delete","values","next","reset","e","message","uploadedExpressionsPack","packId","dependencies","packCredits","characters","fonts","sprites","poemStyles","poemBackgrounds","backgrounds","colors","masks","adds","baseUrl","listPaths","partFiles","charDefDefaults","characterType","freeMove","close","styleGroupId","styleId","poseId","posePositions","panelId","id","y","rotation","preserveRatio","ratio","opacity","version","flip","onTop","composite","filters","mixins","components","Selection","Selector","ToggleBox","DropTarget","DFieldset","L","character","required","initHeadGroup","everythingBroken","created","window","exp","processExpression","bind","find","group","applySingleHeadGroup","watch","redraw","methods","uploadInput","files","file","url","URL","createObjectURL","addUrl","environment","prompt","push","asset","renderer","renderToBlob","rx","drawImage","image","x","w","h","addition","blob","finalExpression","startsWith","revokeObjectURL","head","indexOf","textboxColor","enlargeWhenTalking","nameboxWidth","zoom","temporaryCharacterModel","charRenderer","$nextTick","target","ctx","getContext","clearRect","paintOnto","run","processedExpressions","filter","storeCharacter","$store","content","current","char","heads","styleGroups","chibi","defaultScale","hd","storeHeadGroup","previewSize","previewOffset","variants","processedExpression","vuexHistory","transaction","dispatch","contentPack","splice","parts","split","actualName","trim","toUpperCase","toLowerCase","dataTransfer","effectAllowed","Array","from","items","item","match","dt","show","hide","characterData","headTypes","Object","keys","headTypeKey","headType","lq","partsFiles","hq","charName","headGroupName","poses","styleGroupIdx","styleGroup","styleIdx","styles","poseIdx","compatibleHeads","includes","expressionModels","sourcePack","styleComponents","renderCommands","headIdx","findIndex","command","headRenderCommand","newHeadCommand","offset"],"mappings":"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","file":"js/chunk-57967dfc.2f238bd3.js","sourcesContent":["export * from \"-!../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../node_modules/@vue/cli-service/node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../node_modules/@vue/cli-service/node_modules/vue-loader-v16/dist/index.js??ref--0-1!./index.vue?vue&type=style&index=0&id=123a5ebc&lang=scss&scoped=true\"","export * from \"-!../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../node_modules/@vue/cli-service/node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../node_modules/@vue/cli-service/node_modules/vue-loader-v16/dist/index.js??ref--0-1!./selection.vue?vue&type=style&index=0&id=044096e4&lang=scss&scoped=true\"","export * from \"-!../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../node_modules/@vue/cli-service/node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../../node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-2!../../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../../node_modules/@vue/cli-service/node_modules/vue-loader-v16/dist/index.js??ref--0-1!./selector.vue?vue&type=style&index=0&id=2f9a028c&scoped=true&lang=css\"","<template>\n\t<div class=\"wrapper\" @dragenter=\"dragEnter\" @mouseleave=\"hideDt\">\n\t\t<h1>Add expressions</h1>\n\t\t<selector\n\t\t\tv-if=\"!headGroup\"\n\t\t\tlabel=\"What kind of expression would you like to add?\"\n\t\t>\n\t\t\t<selection\n\t\t\t\tv-for=\"headgroup of availableHeadGroups\"\n\t\t\t\t:key=\"headgroup.name\"\n\t\t\t\t:label=\"normalizeName(headgroup.name)\"\n\t\t\t\t:images=\"headgroup.preview\"\n\t\t\t\t@selected=\"headGroup = headgroup\"\n\t\t\t/>\n\t\t</selector>\n\t\t<selector\n\t\t\tv-else-if=\"!method\"\n\t\t\tlabel=\"How would you like to add the new expressions?\"\n\t\t>\n\t\t\t<selection\n\t\t\t\tlabel=\"Build expressions from parts\"\n\t\t\t\ticon=\"info\"\n\t\t\t\t:disabled=\"hasParts\"\n\t\t\t\t@selected=\"method = 'parts'\"\n\t\t\t/>\n\t\t\t<selection\n\t\t\t\tlabel=\"Upload expression images\"\n\t\t\t\ticon=\"info\"\n\t\t\t\t@selected=\"method = 'upload'\"\n\t\t\t/>\n\t\t</selector>\n\t\t<template v-else-if=\"method === 'upload'\">\n\t\t\t<div v-if=\"!uploadsFinished\" class=\"page\">\n\t\t\t\t<h2>\n\t\t\t\t\tUpload new '{{ normalizeName(headGroup.name) }}' expressions\n\t\t\t\t\t<l v-if=\"downloadLink\" :to=\"downloadLink\">(Template)</l>\n\t\t\t\t\t<l v-if=\"listLink\" :to=\"listLink\">(List)</l>\n\t\t\t\t</h2>\n\t\t\t\t<drop-target ref=\"dt\" class=\"drop-target\" @drop=\"addByImageFile\"\n\t\t\t\t\t>Drop here to add as a new expression</drop-target\n\t\t\t\t>\n\t\t\t\t<div class=\"expression_list_wrapper\">\n\t\t\t\t\t<div class=\"expression_list\" @wheel.passive=\"verticalScrollRedirect\">\n\t\t\t\t\t\t<button @click=\"$refs.upload.click()\">\n\t\t\t\t\t\t\tUpload expression\n\t\t\t\t\t\t\t<input type=\"file\" ref=\"upload\" multiple @change=\"addByUpload\" />\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button @click=\"addByUrl\">Add expression from URL</button>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-for=\"(expression, idx) of uploadedExpressions\"\n\t\t\t\t\t\t\t:key=\"idx\"\n\t\t\t\t\t\t\t:style=\"{ backgroundImage: `url('${expression}')` }\"\n\t\t\t\t\t\t\t:class=\"{\n\t\t\t\t\t\t\t\texpression_item: true,\n\t\t\t\t\t\t\t\tactive: currentUploadedExpression === expression,\n\t\t\t\t\t\t\t}\"\n\t\t\t\t\t\t\t@click=\"currentUploadedExpression = expression\"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"options_wrapper\">\n\t\t\t\t\t\t<div class=\"image\">\n\t\t\t\t\t\t\t<canvas\n\t\t\t\t\t\t\t\tref=\"target\"\n\t\t\t\t\t\t\t\t:width=\"previewPoses[previewPoseIdx].width\"\n\t\t\t\t\t\t\t\t:height=\"previewPoses[previewPoseIdx].height\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\tPreview pose:\n\t\t\t\t\t\t\t<select v-model=\"previewPoseIdx\">\n\t\t\t\t\t\t\t\t<option\n\t\t\t\t\t\t\t\t\tv-for=\"(pose, idx) of previewPoses\"\n\t\t\t\t\t\t\t\t\t:key=\"idx\"\n\t\t\t\t\t\t\t\t\t:value=\"idx\"\n\t\t\t\t\t\t\t\t\t>{{ normalizeName(pose.name) }}</option\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<d-fieldset title=\"Offset\">\n\t\t\t\t\t\t\t\t<table>\n\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t<th>X:</th>\n\t\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\t\ttype=\"number\"\n\t\t\t\t\t\t\t\t\t\t\t\tv-model.number=\"offsetX\"\n\t\t\t\t\t\t\t\t\t\t\t\t@keydown.stop\n\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t<th>Y:</th>\n\t\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\t\t\ttype=\"number\"\n\t\t\t\t\t\t\t\t\t\t\t\tv-model.number=\"offsetY\"\n\t\t\t\t\t\t\t\t\t\t\t\t@keydown.stop\n\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t</d-fieldset>\n\t\t\t\t\t\t\t<toggle-box\n\t\t\t\t\t\t\t\tlabel=\"Reduce to fit DDDG standard\"\n\t\t\t\t\t\t\t\tv-if=\"headGroup.imagePatching && headGroup.imagePatching.mask\"\n\t\t\t\t\t\t\t\tv-model=\"addMask\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<toggle-box\n\t\t\t\t\t\t\t\tlabel=\"Add new parts to fit DDDG standard\"\n\t\t\t\t\t\t\t\tv-if=\"\n\t\t\t\t\t\t\t\t\theadGroup.imagePatching && headGroup.imagePatching.addition\n\t\t\t\t\t\t\t\t\"\n\t\t\t\t\t\t\t\tv-model=\"addExtras\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t:disabled=\"currentUploadedExpression === null\"\n\t\t\t\t\t\t\t\t@click=\"removeUploadedExpression\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tRemove this expression\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button @click=\"finishUpload\">Finish</button>\n\t\t\t\t\t\t\t<button @click=\"leave\">Abort</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-else>\n\t\t\t\t<h2>\n\t\t\t\t\tFinishing up images. {{ Math.round(batchRunner.percentage * 100) }}%\n\t\t\t\t</h2>\n\t\t\t</div>\n\t\t</template>\n\t</div>\n</template>\n\n<script lang=\"ts\">\n// App.vue has currently so many responsiblities that it's best to break it into chunks\nimport Selection from './selection.vue';\nimport Selector from './selector.vue';\nimport DropTarget from '../../toolbox/drop-target.vue';\nimport ToggleBox from '@/components/toggle.vue';\nimport environment from '@/environments/environment';\nimport { VerticalScrollRedirect } from '@/components/vertical-scroll-redirect';\nimport DFieldset from '@/components/ui/d-fieldset.vue';\nimport { Character } from '../../../renderables/character';\nimport {\n\tContentPack,\n\tCharacter as CharacterModel,\n\tPose,\n\tIHeadCommand,\n} from '@edave64/doki-doki-dialog-generator-pack-format/dist/v2/model';\nimport { IAsset, ReplaceContentPackAction } from '../../../store/content';\nimport { getAssetByUrl } from '../../../asset-manager';\nimport { Renderer } from '../../../renderer/renderer';\nimport { WorkBatch } from '../../../util/workBatch';\nimport { defineComponent } from 'vue';\nimport { DeepReadonly } from '@/util/readonly';\nimport L from '@/components/ui/link.vue';\n\nconst uploadedExpressionsPack: ContentPack<string> = {\n\tpackId: 'dddg.buildin.uploadedExpressions',\n\tdependencies: [],\n\tpackCredits: [],\n\tcharacters: [],\n\tfonts: [],\n\tsprites: [],\n\tpoemStyles: [],\n\tpoemBackgrounds: [],\n\tbackgrounds: [],\n\tcolors: [],\n};\n\nconst masks: { [s: string]: string | undefined } = {\n\t'dddg.buildin.base.monika:straight': 'assets/mask/monika-a-mask.png',\n\t'dddg.buildin.base.monika:sideways': 'assets/mask/monika-b-mask.png',\n\t'dddg.buildin.base.natsuki:straight': 'assets/mask/natsuki-a-mask.png',\n\t'dddg.buildin.base.natsuki:sideways': 'assets/mask/natsuki-b-mask.png',\n\t'dddg.buildin.base.natsuki:turnedAway': 'assets/mask/natsuki-c-mask.png',\n\t'dddg.buildin.base.sayori:straight': 'assets/mask/sayori-a-mask.png',\n\t'dddg.buildin.base.sayori:sideways': 'assets/mask/sayori-b-mask.png',\n\t'dddg.buildin.base.yuri:straight': 'assets/mask/yuri-a-mask.png',\n\t'dddg.buildin.base.yuri:sideways': 'assets/mask/yuri-b-mask.png',\n};\n\nconst adds: { [s: string]: string | undefined } = {\n\t'dddg.buildin.base.natsuki:straight': 'assets/mask/natsuki-a-add.png',\n};\n\nconst baseUrl =\n\t'https://github.com/edave64/Doki-Doki-Dialog-Generator/tree/master/public/assets/';\n\nconst listPaths: { [s: string]: string | undefined } = {\n\t'dddg.buildin.base.monika:ddlc.monika': `${baseUrl}monika`,\n\t'dddg.buildin.base.natsuki:ddlc.natsuki': `${baseUrl}natsuki`,\n\t'dddg.buildin.base.sayori:ddlc.sayori': `${baseUrl}sayori`,\n\t'dddg.buildin.base.yuri:ddlc.yuri': `${baseUrl}yuri`,\n\t'dddg.buildin.amy1:ddlc.fan.amy1': `${baseUrl}classic_amy`,\n\t'dddg.buildin.amy2:ddlc.fan.amy2': `${baseUrl}amy`,\n\t'dddg.buildin.femc:ddlc.fan.femc': `${baseUrl}femc`,\n\t'dddg.buildin.femc:ddlc.fan.femc:straight_lh': `${baseUrl}femc_lh`,\n\t'dddg.buildin.femc:ddlc.fan.femc:straight_hetero': `${baseUrl}femc/hetero`,\n\t'dddg.buildin.femc:ddlc.fan.femc:straight_hetero_lh': `${baseUrl}femc_lh/hetero`,\n\t'dddg.buildin.mc_classic:ddlc.fan.mc1': `${baseUrl}classic_mc`,\n\t'dddg.buildin.mc:ddlc.fan.mc2': `${baseUrl}mc`,\n\t'dddg.buildin.mc:ddlc.fan.mc2:straight_red': `${baseUrl}mc/red`,\n\t'dddg.buildin.mc_chad:ddlc.fan.mc_chad': `${baseUrl}chad`,\n\t'dddg.buildin.mc_chad:ddlc.fan.mc_chad:straight_red': `${baseUrl}chad/red`,\n};\n\nconst partFiles: { [s: string]: string[] | undefined } = {};\n\nconst charDefDefaults = {\n\ttype: 'character' as 'character',\n\tcharacterType: '',\n\tfreeMove: false,\n\tclose: false,\n\tstyleGroupId: 0,\n\tstyleId: 0,\n\tposeId: 0,\n\tposePositions: {},\n\tpanelId: '',\n\tid: '',\n\ty: 0,\n\trotation: 0,\n\tpreserveRatio: true,\n\tratio: 1,\n\topacity: 100,\n\tversion: 1,\n\tflip: false,\n\tonTop: false,\n\tcomposite: 'source-over' as 'source-over',\n\tfilters: [],\n};\n\nexport default defineComponent({\n\tmixins: [VerticalScrollRedirect],\n\tcomponents: { Selection, Selector, ToggleBox, DropTarget, DFieldset, L },\n\tprops: {\n\t\tcharacter: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tinitHeadGroup: String,\n\t},\n\tdata: () => ({\n\t\tmethod: 'upload' as null | 'upload' | 'parts',\n\t\theadGroup: null as null | IHeadGroup,\n\t\tuploadsFinished: false,\n\t\teverythingBroken: false,\n\t\tuploadedExpressions: [] as string[],\n\t\tcurrentUploadedExpression: null as string | null,\n\t\tpreviewPoseIdx: 0,\n\t\toffsetX: 0,\n\t\toffsetY: 0,\n\t\taddMask: false,\n\t\taddExtras: false,\n\t\tbatchRunner: null! as WorkBatch<string, string>,\n\t}),\n\tcreated() {\n\t\t(window as any).exp = this;\n\t\tthis.batchRunner = new WorkBatch<string, string>(\n\t\t\tthis.processExpression.bind(this),\n\t\t\tasync () => {}\n\t\t);\n\t\tif (this.initHeadGroup) {\n\t\t\tthis.headGroup = this.availableHeadGroups.find(\n\t\t\t\tgroup => group.name === this.initHeadGroup\n\t\t\t)!;\n\t\t}\n\t\tthis.applySingleHeadGroup();\n\t},\n\twatch: {\n\t\tavailableHeadGroups() {\n\t\t\tthis.applySingleHeadGroup();\n\t\t},\n\t\tpreviewPoseIdx() {\n\t\t\tthis.redraw();\n\t\t},\n\t\tpreviewPoses() {\n\t\t\tthis.redraw();\n\t\t},\n\t\tcurrentUploadedExpression() {\n\t\t\tthis.redraw();\n\t\t},\n\t\toffsetX() {\n\t\t\tthis.redraw();\n\t\t},\n\t\toffsetY() {\n\t\t\tthis.redraw();\n\t\t},\n\t\taddMask() {\n\t\t\tthis.redraw();\n\t\t},\n\t\taddExtras() {\n\t\t\tthis.redraw();\n\t\t},\n\t},\n\tmethods: {\n\t\tapplySingleHeadGroup() {\n\t\t\tif (this.availableHeadGroups.length === 1) {\n\t\t\t\tthis.headGroup = this.availableHeadGroups[0];\n\t\t\t}\n\t\t},\n\n\t\tasync addByUpload(): Promise<void> {\n\t\t\tconst uploadInput = this.$refs.upload as HTMLInputElement;\n\t\t\tif (!uploadInput.files) return;\n\t\t\tfor (const file of uploadInput.files) {\n\t\t\t\tthis.addByImageFile(file);\n\t\t\t}\n\t\t},\n\n\t\taddByImageFile(file: File) {\n\t\t\tconst url = URL.createObjectURL(file);\n\t\t\tthis.addUrl(url);\n\t\t},\n\n\t\tasync addByUrl(): Promise<void> {\n\t\t\tconst url = await environment.prompt('Enter the url of the image.', '');\n\t\t\tif (!url) return;\n\t\t\tthis.addUrl(url);\n\t\t},\n\n\t\taddUrl(url: string): void {\n\t\t\tthis.currentUploadedExpression = url;\n\t\t\tthis.uploadedExpressions.push(url);\n\t\t},\n\n\t\tasync processExpression(\n\t\t\texpression: string,\n\t\t\tisRunning: () => boolean\n\t\t): Promise<string | undefined> {\n\t\t\tconst asset = (await getAssetByUrl(expression)) as HTMLImageElement;\n\t\t\tif (!isRunning()) return undefined;\n\t\t\tconst renderer = new Renderer(\n\t\t\t\tasset.width + this.offsetX,\n\t\t\t\tasset.height + this.offsetY\n\t\t\t);\n\t\t\tconst blob = await renderer.renderToBlob(async rx => {\n\t\t\t\trx.drawImage({\n\t\t\t\t\timage: asset,\n\t\t\t\t\tx: this.offsetX,\n\t\t\t\t\ty: this.offsetY,\n\t\t\t\t\tw: asset.width,\n\t\t\t\t\th: asset.height,\n\t\t\t\t});\n\n\t\t\t\tif (\n\t\t\t\t\tthis.addMask &&\n\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\tthis.headGroup.imagePatching.mask\n\t\t\t\t) {\n\t\t\t\t\tconst mask = (await getAssetByUrl(\n\t\t\t\t\t\tthis.headGroup.imagePatching.mask\n\t\t\t\t\t)) as HTMLImageElement;\n\t\t\t\t\tif (!isRunning()) return undefined;\n\t\t\t\t\trx.drawImage({\n\t\t\t\t\t\timage: mask,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\tw: mask.width,\n\t\t\t\t\t\th: mask.height,\n\t\t\t\t\t\tcomposite: 'destination-in',\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\tthis.addExtras &&\n\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\tthis.headGroup.imagePatching.addition\n\t\t\t\t) {\n\t\t\t\t\tconst addition = (await getAssetByUrl(\n\t\t\t\t\t\tthis.headGroup.imagePatching.addition\n\t\t\t\t\t)) as HTMLImageElement;\n\t\t\t\t\tif (!isRunning()) return undefined;\n\t\t\t\t\trx.drawImage({\n\t\t\t\t\t\timage: addition,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\tw: addition.width,\n\t\t\t\t\t\th: addition.height,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\tconst finalExpression = URL.createObjectURL(blob);\n\n\t\t\tif (expression !== finalExpression && expression.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(expression);\n\t\t\t}\n\n\t\t\treturn finalExpression;\n\t\t},\n\n\t\tasync redraw() {\n\t\t\tif (this.uploadsFinished) return;\n\t\t\tconst pose = this.previewPoses[this.previewPoseIdx];\n\t\t\tif (!pose) return;\n\t\t\tlet charRenderer: Character;\n\t\t\ttry {\n\t\t\t\tcharRenderer = new Character(\n\t\t\t\t\t{\n\t\t\t\t\t\t...charDefDefaults,\n\t\t\t\t\t\twidth: pose.width,\n\t\t\t\t\t\theight: pose.height,\n\t\t\t\t\t\tposeId: this.previewPoseIdx,\n\t\t\t\t\t\tx: pose.width / 2,\n\t\t\t\t\t\tposePositions: {\n\t\t\t\t\t\t\theadGroup: 0,\n\t\t\t\t\t\t\thead: this.uploadedExpressions.indexOf(\n\t\t\t\t\t\t\t\tthis.currentUploadedExpression!\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlabel: null,\n\t\t\t\t\t\ttextboxColor: null,\n\t\t\t\t\t\tenlargeWhenTalking: false,\n\t\t\t\t\t\tnameboxWidth: null,\n\t\t\t\t\t\tzoom: 1,\n\t\t\t\t\t},\n\t\t\t\t\tawait this.temporaryCharacterModel\n\t\t\t\t);\n\t\t\t} catch (e) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$nextTick(async () => {\n\t\t\t\tif (this.uploadsFinished) return;\n\t\t\t\tconst renderer = new Renderer(pose.width, pose.height);\n\t\t\t\tawait renderer.render(async rx => {\n\t\t\t\t\tawait charRenderer.render(false, rx);\n\t\t\t\t});\n\n\t\t\t\tconst target = this.$refs.target as HTMLCanvasElement;\n\t\t\t\tconst ctx = target.getContext('2d')!;\n\t\t\t\tctx.clearRect(0, 0, target.width, target.height);\n\t\t\t\trenderer.paintOnto(ctx, {\n\t\t\t\t\tx: 0,\n\t\t\t\t\ty: 0,\n\t\t\t\t\tw: target.width,\n\t\t\t\t\th: target.height,\n\t\t\t\t});\n\t\t\t});\n\t\t},\n\n\t\tasync finishUpload() {\n\t\t\tthis.uploadsFinished = true;\n\t\t\tconst processedExpressions = (\n\t\t\t\tawait this.batchRunner.run(this.uploadedExpressions)\n\t\t\t).filter(exp => exp) as string[];\n\n\t\t\tconst storeCharacter = this.$store.state.content.current.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t)!;\n\t\t\tlet character = uploadedExpressionsPack.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t);\n\t\t\tif (!character) {\n\t\t\t\tcharacter = {\n\t\t\t\t\tid: this.character,\n\t\t\t\t\theads: {},\n\t\t\t\t\tstyleGroups: [],\n\t\t\t\t\tlabel: '',\n\t\t\t\t\tchibi: '',\n\t\t\t\t\tsize: [960, 960],\n\t\t\t\t\tdefaultScale: [0.8, 0.8],\n\t\t\t\t\thd: false,\n\t\t\t\t} as CharacterModel<string>;\n\t\t\t\tuploadedExpressionsPack.characters.push(character);\n\t\t\t}\n\n\t\t\tlet headGroup = character.heads[this.headGroup!.name];\n\t\t\tconst storeHeadGroup = storeCharacter.heads[this.headGroup!.name];\n\t\t\tif (!headGroup) {\n\t\t\t\theadGroup = {\n\t\t\t\t\tpreviewSize: storeHeadGroup.previewSize as any,\n\t\t\t\t\tpreviewOffset: storeHeadGroup.previewOffset as any,\n\t\t\t\t\tvariants: [],\n\t\t\t\t};\n\t\t\t\tcharacter.heads[this.headGroup!.name] = headGroup;\n\t\t\t}\n\n\t\t\tfor (const processedExpression of processedExpressions) {\n\t\t\t\theadGroup.variants.push([processedExpression]);\n\t\t\t}\n\n\t\t\tawait this.vuexHistory.transaction(() => {\n\t\t\t\tthis.$store.dispatch('content/replaceContentPack', {\n\t\t\t\t\tcontentPack: uploadedExpressionsPack,\n\t\t\t\t} as ReplaceContentPackAction);\n\t\t\t});\n\n\t\t\tthis.leave();\n\t\t},\n\n\t\tleave() {\n\t\t\tthis.$emit('leave');\n\t\t\tthis.method = null;\n\t\t\tthis.headGroup = null;\n\t\t\tthis.uploadedExpressions = [];\n\t\t},\n\n\t\tremoveUploadedExpression() {\n\t\t\tif (!this.currentUploadedExpression) return;\n\t\t\tconst expression = this.currentUploadedExpression;\n\t\t\tthis.currentUploadedExpression = null;\n\t\t\tif (expression.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(expression);\n\t\t\t}\n\t\t\tlet idx = this.uploadedExpressions.indexOf(expression);\n\t\t\tthis.uploadedExpressions.splice(idx, 1);\n\t\t\tif (idx > this.uploadedExpressions.length - 1) {\n\t\t\t\tidx = this.uploadedExpressions.length - 1;\n\t\t\t}\n\t\t\tthis.currentUploadedExpression = this.uploadedExpressions[idx] || null;\n\t\t},\n\n\t\tnormalizeName(name: string): string {\n\t\t\tconst parts = name.split(':');\n\t\t\tlet actualName = parts[parts.length - 1];\n\t\t\tconst packId = parts.length > 1 ? parts[0].trim() : '';\n\n\t\t\tactualName = (\n\t\t\t\tactualName[0].toUpperCase() + actualName.slice(1).toLowerCase()\n\t\t\t)\n\t\t\t\t.split('_')\n\t\t\t\t.join(' ');\n\t\t\tif (packId.startsWith('dddg.') || packId === '') {\n\t\t\t\treturn actualName;\n\t\t\t}\n\t\t\treturn packId + ': ' + actualName;\n\t\t},\n\n\t\tdragEnter(e: DragEvent) {\n\t\t\tif (!this.headGroup || this.method !== 'upload') return;\n\t\t\tif (!e.dataTransfer) return;\n\t\t\te.dataTransfer.effectAllowed = 'none';\n\t\t\tif (\n\t\t\t\t!Array.from(e.dataTransfer.items).find(item =>\n\t\t\t\t\titem.type.match(/^image.*$/)\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\te.dataTransfer.effectAllowed = 'link';\n\t\t\t(this.$refs.dt as any).show();\n\t\t},\n\n\t\thideDt() {\n\t\t\tif (this.$refs.dt) (this.$refs.dt as any).hide();\n\t\t},\n\t},\n\tcomputed: {\n\t\tcharacterData(): DeepReadonly<CharacterModel<IAsset>> {\n\t\t\treturn this.$store.state.content.current.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t)!;\n\t\t},\n\n\t\tavailableHeadGroups(): IHeadGroup[] {\n\t\t\tconst characterData = this.characterData;\n\t\t\tconst headTypes = Object.keys(characterData.heads);\n\t\t\treturn headTypes.map(headTypeKey => {\n\t\t\t\tconst headType = characterData.heads[headTypeKey];\n\n\t\t\t\treturn {\n\t\t\t\t\tname: headTypeKey,\n\t\t\t\t\tpreview: headType.variants[0].map(asset => asset.lq),\n\t\t\t\t\tpartsFiles: partFiles[headTypeKey] || [],\n\t\t\t\t\timagePatching: {\n\t\t\t\t\t\tmask: masks[headTypeKey],\n\t\t\t\t\t\taddition: adds[headTypeKey],\n\t\t\t\t\t},\n\t\t\t\t} as IHeadGroup;\n\t\t\t});\n\t\t},\n\n\t\thasParts(): boolean {\n\t\t\treturn !!this.availableHeadGroups.find(\n\t\t\t\theadGroup => headGroup.partsFiles.length > 0\n\t\t\t);\n\t\t},\n\n\t\tdownloadLink(): string | null {\n\t\t\tconst character = this.characterData;\n\t\t\tif (!character || !this.headGroup) return null;\n\t\t\tconst headType = character.heads[this.headGroup!.name];\n\t\t\tif (!headType) return null;\n\t\t\treturn headType.variants[0][0].hq;\n\t\t},\n\n\t\tlistLink(): string | null {\n\t\t\tif (!this.characterData || !this.headGroup) return null;\n\t\t\tconst charName = this.characterData.id;\n\t\t\tconst headGroupName = this.headGroup.name;\n\t\t\tif (listPaths[charName + ':' + headGroupName]) {\n\t\t\t\treturn listPaths[charName + ':' + headGroupName] || null;\n\t\t\t}\n\t\t\treturn listPaths[charName] || null;\n\t\t},\n\n\t\tpreviewPoses(): IPose[] {\n\t\t\tconst character = this.characterData;\n\t\t\tif (!character || !this.headGroup) return [];\n\t\t\tconst poses: IPose[] = [];\n\n\t\t\tfor (\n\t\t\t\tlet styleGroupIdx = 0;\n\t\t\t\tstyleGroupIdx < character.styleGroups.length;\n\t\t\t\t++styleGroupIdx\n\t\t\t) {\n\t\t\t\tconst styleGroup = character.styleGroups[styleGroupIdx];\n\t\t\t\tfor (\n\t\t\t\t\tlet styleIdx = 0;\n\t\t\t\t\tstyleIdx < styleGroup.styles.length;\n\t\t\t\t\t++styleIdx\n\t\t\t\t) {\n\t\t\t\t\tconst style = styleGroup.styles[styleIdx];\n\t\t\t\t\tfor (let poseIdx = 0; poseIdx < style.poses.length; ++poseIdx) {\n\t\t\t\t\t\tconst pose = style.poses[poseIdx];\n\t\t\t\t\t\tif (pose.compatibleHeads.includes(this.headGroup.name)) {\n\t\t\t\t\t\t\tposes.push({\n\t\t\t\t\t\t\t\tname: pose.id,\n\t\t\t\t\t\t\t\tstyleGroupId: styleGroupIdx,\n\t\t\t\t\t\t\t\tstyleId: styleIdx,\n\t\t\t\t\t\t\t\tposeId: poseIdx,\n\t\t\t\t\t\t\t\twidth: pose.size[0],\n\t\t\t\t\t\t\t\theight: pose.size[1],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn poses;\n\t\t},\n\n\t\texpressionModels(): IAsset[][] {\n\t\t\treturn this.uploadedExpressions.map(expression => [\n\t\t\t\t{\n\t\t\t\t\thq: expression,\n\t\t\t\t\tlq: expression,\n\t\t\t\t\tsourcePack: 'dddg.temp1:default',\n\t\t\t\t} as IAsset,\n\t\t\t]);\n\t\t},\n\n\t\ttemporaryCharacterModel(): CharacterModel<IAsset> {\n\t\t\tconst poses = this.previewPoses;\n\t\t\tconst character = this.$store.state.content.current.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t)!;\n\t\t\tconst offsetX = this.offsetX;\n\t\t\tconst offsetY = this.offsetY;\n\n\t\t\treturn {\n\t\t\t\tid: this.character,\n\t\t\t\tsize: [960, 960],\n\t\t\t\tdefaultScale: [0.8, 0.8],\n\t\t\t\thd: false,\n\t\t\t\theads: {\n\t\t\t\t\t'dddg.temp1:default': {\n\t\t\t\t\t\tvariants: this.expressionModels,\n\t\t\t\t\t\tpreviewSize: [0, 0],\n\t\t\t\t\t\tpreviewOffset: [0, 0],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tstyleGroups: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'preview',\n\t\t\t\t\t\tstyleComponents: [],\n\t\t\t\t\t\tstyles: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcomponents: {},\n\t\t\t\t\t\t\t\tposes: poses.map((pose, idx) => {\n\t\t\t\t\t\t\t\t\tconst styleGroup = character.styleGroups[pose.styleGroupId];\n\t\t\t\t\t\t\t\t\tconst style = styleGroup.styles[pose.styleId];\n\t\t\t\t\t\t\t\t\tconst renderCommands = style.poses[\n\t\t\t\t\t\t\t\t\t\tpose.poseId\n\t\t\t\t\t\t\t\t\t].renderCommands.slice(0);\n\t\t\t\t\t\t\t\t\tlet headIdx = renderCommands.findIndex(\n\t\t\t\t\t\t\t\t\t\tcommand => command.type === 'head'\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tconst headRenderCommand = renderCommands[headIdx];\n\t\t\t\t\t\t\t\t\tconst newHeadCommand: IHeadCommand = {\n\t\t\t\t\t\t\t\t\t\ttype: 'head',\n\t\t\t\t\t\t\t\t\t\toffset: [\n\t\t\t\t\t\t\t\t\t\t\theadRenderCommand.offset[0] + offsetX,\n\t\t\t\t\t\t\t\t\t\t\theadRenderCommand.offset[1] + offsetY,\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\tthis.addMask &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching.mask\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\tconst mask = this.headGroup.imagePatching.mask;\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(headIdx, 1);\n\t\t\t\t\t\t\t\t\t\theadIdx = 1;\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(0, 0, newHeadCommand, {\n\t\t\t\t\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\t\t\t\t\timages: [\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\thq: mask,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlq: mask,\n\t\t\t\t\t\t\t\t\t\t\t\t\tsourcePack: 'dddg.temp1',\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\tcomposite: 'destination-in',\n\t\t\t\t\t\t\t\t\t\t\toffset: headRenderCommand.offset,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(headIdx, 1, newHeadCommand);\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\tthis.addExtras &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching.addition\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\tconst add = this.headGroup.imagePatching.addition;\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(headIdx + 1, 0, {\n\t\t\t\t\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\t\t\t\t\timages: [\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\thq: add,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlq: add,\n\t\t\t\t\t\t\t\t\t\t\t\t\tsourcePack: 'dddg.temp1',\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\toffset: headRenderCommand.offset,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t...style.poses[pose.poseId],\n\t\t\t\t\t\t\t\t\t\trenderCommands,\n\t\t\t\t\t\t\t\t\t\tid: 'dddg.temp1:pose' + idx,\n\t\t\t\t\t\t\t\t\t\tcompatibleHeads: ['dddg.temp1:default'],\n\t\t\t\t\t\t\t\t\t} as Pose<IAsset>;\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tlabel: '',\n\t\t\t\tchibi: null!,\n\t\t\t};\n\t\t},\n\t},\n});\n\ninterface IPose {\n\tname: string;\n\tstyleGroupId: number;\n\tstyleId: number;\n\tposeId: number;\n\twidth: number;\n\theight: number;\n}\n\ninterface IHeadGroup {\n\tname: string;\n\tpreview: string[];\n\tpartsFiles: string[];\n\timagePatching?: {\n\t\tmask?: string;\n\t\taddition?: string;\n\t};\n}\n\ninterface ICachedProcessedExpression {\n\turl: string;\n\taddMask: boolean;\n\taddExtras: boolean;\n\toffsetX: number;\n\toffsetY: number;\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.expression_list_wrapper {\n\tdisplay: flex;\n\tflex-direction: column;\n\tflex-grow: 1;\n\tflex-shrink: 1;\n}\n\n.options_wrapper {\n\tdisplay: flex;\n\tflex-direction: column;\n\tflex-grow: 1;\n\tflex-shrink: 1;\n}\n\n.expression_list {\n\tdisplay: flex;\n\tflex-direction: row;\n\toverflow: auto;\n\n\tbutton {\n\t\twidth: 100px;\n\t\theight: 128px;\n\t}\n\n\t* {\n\t\tflex-shrink: 0;\n\t}\n}\n\n.expression_item {\n\theight: 128px;\n\twidth: 128px;\n\tbackground-position: center center;\n\tbackground-size: contain;\n\tbackground-repeat: no-repeat;\n\tbox-shadow: inset 0 0 1px 3px rgba(0, 0, 0, 0.5);\n\tbox-sizing: border-box;\n\n\t&.active {\n\t\tbox-shadow: inset 0 0 1px 3px rgba(0, 0, 0, 0.25);\n\t}\n}\n\ninput[type='file'] {\n\tdisplay: none;\n}\n\n.wrapper {\n\theight: 100%;\n\twidth: 100%;\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.page {\n\tflex-grow: 1;\n\tflex-shrink: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\n\t.image {\n\t\tflex-grow: 1;\n\t\tflex-shrink: 1;\n\t\tposition: relative;\n\t\tbackground-size: contain;\n\t\tbackground-position: center center;\n\t\tbackground-repeat: no-repeat;\n\n\t\tcanvas {\n\t\t\tposition: absolute;\n\t\t\tmax-height: 100%;\n\t\t\tmax-width: 100%;\n\t\t}\n\t}\n}\n\n@media only screen and (max-height: 560px) {\n\t.expression_list_wrapper {\n\t\tflex-direction: row;\n\t\theight: 1px;\n\n\t\t.expression_list {\n\t\t\tflex-direction: column;\n\t\t\twidth: 128px;\n\t\t\toverflow: auto;\n\n\t\t\tbutton {\n\t\t\t\theight: 64px;\n\t\t\t\twidth: 100%;\n\t\t\t}\n\n\t\t\t.expression_item {\n\t\t\t\twidth: 100%;\n\t\t\t}\n\t\t}\n\t}\n}\n</style>\n","<template>\n\t<div\n\t\tclass=\"selection\"\n\t\t:style=\"{ background: background }\"\n\t\t@click.stop=\"$emit('selected')\"\n\t>\n\t\t<div class=\"icon material-icons\">{{ icon }}</div>\n\t\t<div class=\"label\">{{ label }}</div>\n\t</div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue';\n\nexport default defineComponent({\n\tprops: {\n\t\ticon: String,\n\t\tlabel: String,\n\t\timages: {\n\t\t\tdefault: [] as string[],\n\t\t},\n\t},\n\tcomputed: {\n\t\tbackground(): string {\n\t\t\treturn this.images\n\t\t\t\t.map(i => `center / contain no-repeat url('${i}')`)\n\t\t\t\t.join(',');\n\t\t},\n\t},\n});\n</script>\n\n<style lang=\"scss\" scoped>\n.selection {\n\tflex-grow: 1;\n\tflex-shrink: 1;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-content: center;\n\tflex-direction: column;\n\ttext-align: center;\n\n\tmargin-top: 4px;\n\tbackground-size: cover;\n\ttext-shadow: 0 0 4px #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,\n\t\t1px 1px 0 #000;\n\tcolor: white;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tbox-shadow: inset 0 0 1px 3px $default-modal-backdrop;\n\tbox-shadow: inset 0 0 1px 3px --modal-backdrop;\n\ttext-align: center;\n\tuser-select: none;\n}\n</style>\n","\nimport { defineComponent } from 'vue';\n\nexport default defineComponent({\n\tprops: {\n\t\ticon: String,\n\t\tlabel: String,\n\t\timages: {\n\t\t\tdefault: [] as string[],\n\t\t},\n\t},\n\tcomputed: {\n\t\tbackground(): string {\n\t\t\treturn this.images\n\t\t\t\t.map(i => `center / contain no-repeat url('${i}')`)\n\t\t\t\t.join(',');\n\t\t},\n\t},\n});\n","import { render } from \"./selection.vue?vue&type=template&id=044096e4&scoped=true\"\nimport script from \"./selection.vue?vue&type=script&lang=ts\"\nexport * from \"./selection.vue?vue&type=script&lang=ts\"\n\nimport \"./selection.vue?vue&type=style&index=0&id=044096e4&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-044096e4\"\n\nexport default script","<template>\n\t<div class=\"selector\">\n\t\t<slot />\n\t</div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue';\n\nexport default defineComponent({});\n</script>\n\n<style scoped>\n.selector {\n\tdisplay: flex;\n\tflex-direction: row;\n\tflex-grow: 1;\n\tjustify-content: stretch;\n}\n</style>\n","\nimport { defineComponent } from 'vue';\n\nexport default defineComponent({});\n","import { render } from \"./selector.vue?vue&type=template&id=2f9a028c&scoped=true\"\nimport script from \"./selector.vue?vue&type=script&lang=ts\"\nexport * from \"./selector.vue?vue&type=script&lang=ts\"\n\nimport \"./selector.vue?vue&type=style&index=0&id=2f9a028c&scoped=true&lang=css\"\nscript.render = render\nscript.__scopeId = \"data-v-2f9a028c\"\n\nexport default script","import { reactive } from 'vue';\n\ntype Runner<P, R> = (\n\tpayload: P,\n\tisRunning: () => boolean\n) => Promise<R | undefined>;\n\ntype Disposer<R> = (payload: R) => Promise<void>;\n\nexport class WorkBatch<P, R> {\n\tprivate state = reactive({\n\t\tbusy: false,\n\t\terror: null as string | null,\n\t\tcompleted: 0,\n\t\tfullCount: 0,\n\t});\n\tprivate pendingData: P[] = [];\n\tprivate currentlyRunning = new Set<P>();\n\tprivate resolveCurrentRun:\n\t\t| null\n\t\t| ((data: Array<R | undefined>) => void) = null;\n\tprivate rejectCurrentRun: null | (() => void) = null;\n\tprivate returnData: Array<R | undefined> = [];\n\n\tprivate remainingDisposers: Set<R> = new Set<R>();\n\tprivate runningDisposers: Set<R> = new Set<R>();\n\n\tpublic constructor(\n\t\tprivate readonly runner: Runner<P, R>,\n\t\tprivate readonly disposer: Disposer<R>,\n\t\tprivate readonly parallel = 4\n\t) {}\n\n\tpublic run(newData: P[]): Promise<Array<R | undefined>> {\n\t\tif (this.rejectCurrentRun) {\n\t\t\tthis.reject();\n\t\t}\n\t\tnewData = newData.slice();\n\t\tthis.pendingData = newData;\n\t\tthis.returnData = [];\n\t\tthis.state.fullCount = newData.length;\n\t\tthis.state.error = null;\n\t\tthis.state.busy = true;\n\t\tthis.state.completed = 0;\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.resolveCurrentRun = resolve;\n\t\t\tthis.rejectCurrentRun = reject;\n\t\t\tif (newData.length > 0) {\n\t\t\t\tthis.restock();\n\t\t\t} else {\n\t\t\t\tthis.resolve();\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate get remainingCapacity() {\n\t\treturn (\n\t\t\tthis.parallel - this.currentlyRunning.size - this.runningDisposers.size\n\t\t);\n\t}\n\n\tprivate restock() {\n\t\twhile (this.remainingCapacity > 0 && this.pendingData.length > 0) {\n\t\t\tthis.startOne();\n\t\t}\n\t\twhile (this.remainingCapacity > 0 && this.remainingDisposers.size > 0) {\n\t\t\tthis.startDisposer();\n\t\t}\n\t}\n\n\tprivate async startOne() {\n\t\tconst data = this.pendingData.shift();\n\t\tconst idx = this.returnData.length;\n\t\tthis.returnData[idx] = undefined;\n\t\tif (!data) return;\n\t\tthis.currentlyRunning.add(data);\n\t\tconst isRunning = () => this.currentlyRunning.has(data);\n\t\tlet ret: R | undefined;\n\t\ttry {\n\t\t\tret = await this.runner(data, isRunning);\n\t\t} catch (e) {\n\t\t\tthis.reject(e);\n\t\t}\n\t\tif (isRunning()) {\n\t\t\t++this.state.completed;\n\t\t\tthis.returnData[idx] = ret;\n\t\t\tthis.currentlyRunning.delete(data);\n\t\t\tif (this.currentlyRunning.size === 0 && this.pendingData.length === 0) {\n\t\t\t\tthis.resolve();\n\t\t\t}\n\t\t} else if (ret !== undefined) {\n\t\t\tthis.remainingDisposers.add(ret);\n\t\t}\n\t\tthis.restock();\n\t}\n\n\tprivate async startDisposer() {\n\t\tconst data = this.remainingDisposers.values().next().value;\n\t\tthis.remainingDisposers.delete(data);\n\t\tthis.runningDisposers.add(data);\n\t\ttry {\n\t\t\tawait this.disposer(data);\n\t\t} catch (e) {}\n\t\tthis.runningDisposers.delete(data);\n\t\tthis.restock();\n\t}\n\n\tprivate resolve() {\n\t\tthis.state.busy = false;\n\t\t// Just to be sure\n\t\tthis.state.completed = this.state.fullCount;\n\t\tconst returnData = this.returnData;\n\t\tconst resolveCurrentRun = this.resolveCurrentRun!;\n\t\tthis.reset();\n\t\tresolveCurrentRun(returnData);\n\t}\n\n\tprivate reject(e?: Error) {\n\t\tthis.state.busy = false;\n\t\tthis.state.error = e?.message || null;\n\t\tconst returnData = this.returnData;\n\t\tconst rejectCurrentRun = this.rejectCurrentRun!;\n\t\tthis.reset();\n\t\tfor (const data of returnData) {\n\t\t\tif (data !== undefined) this.remainingDisposers.add(data);\n\t\t}\n\t\trejectCurrentRun();\n\t}\n\n\tprivate reset() {\n\t\tthis.returnData = [];\n\t\tthis.currentlyRunning = new Set<P>();\n\t\tthis.resolveCurrentRun = null;\n\t\tthis.rejectCurrentRun = null;\n\t}\n\n\tpublic get busy(): boolean {\n\t\treturn this.state.busy;\n\t}\n\n\tpublic get fullCount(): number {\n\t\treturn this.state.fullCount;\n\t}\n\n\tpublic get completed(): number {\n\t\treturn this.state.completed;\n\t}\n\n\tpublic get percentage(): number {\n\t\tif (this.fullCount === 0) return 0;\n\t\treturn this.completed / this.fullCount;\n\t}\n\n\tpublic get error(): string | null {\n\t\treturn this.state.error;\n\t}\n}\n","\n// App.vue has currently so many responsiblities that it's best to break it into chunks\nimport Selection from './selection.vue';\nimport Selector from './selector.vue';\nimport DropTarget from '../../toolbox/drop-target.vue';\nimport ToggleBox from '@/components/toggle.vue';\nimport environment from '@/environments/environment';\nimport { VerticalScrollRedirect } from '@/components/vertical-scroll-redirect';\nimport DFieldset from '@/components/ui/d-fieldset.vue';\nimport { Character } from '../../../renderables/character';\nimport {\n\tContentPack,\n\tCharacter as CharacterModel,\n\tPose,\n\tIHeadCommand,\n} from '@edave64/doki-doki-dialog-generator-pack-format/dist/v2/model';\nimport { IAsset, ReplaceContentPackAction } from '../../../store/content';\nimport { getAssetByUrl } from '../../../asset-manager';\nimport { Renderer } from '../../../renderer/renderer';\nimport { WorkBatch } from '../../../util/workBatch';\nimport { defineComponent } from 'vue';\nimport { DeepReadonly } from '@/util/readonly';\nimport L from '@/components/ui/link.vue';\n\nconst uploadedExpressionsPack: ContentPack<string> = {\n\tpackId: 'dddg.buildin.uploadedExpressions',\n\tdependencies: [],\n\tpackCredits: [],\n\tcharacters: [],\n\tfonts: [],\n\tsprites: [],\n\tpoemStyles: [],\n\tpoemBackgrounds: [],\n\tbackgrounds: [],\n\tcolors: [],\n};\n\nconst masks: { [s: string]: string | undefined } = {\n\t'dddg.buildin.base.monika:straight': 'assets/mask/monika-a-mask.png',\n\t'dddg.buildin.base.monika:sideways': 'assets/mask/monika-b-mask.png',\n\t'dddg.buildin.base.natsuki:straight': 'assets/mask/natsuki-a-mask.png',\n\t'dddg.buildin.base.natsuki:sideways': 'assets/mask/natsuki-b-mask.png',\n\t'dddg.buildin.base.natsuki:turnedAway': 'assets/mask/natsuki-c-mask.png',\n\t'dddg.buildin.base.sayori:straight': 'assets/mask/sayori-a-mask.png',\n\t'dddg.buildin.base.sayori:sideways': 'assets/mask/sayori-b-mask.png',\n\t'dddg.buildin.base.yuri:straight': 'assets/mask/yuri-a-mask.png',\n\t'dddg.buildin.base.yuri:sideways': 'assets/mask/yuri-b-mask.png',\n};\n\nconst adds: { [s: string]: string | undefined } = {\n\t'dddg.buildin.base.natsuki:straight': 'assets/mask/natsuki-a-add.png',\n};\n\nconst baseUrl =\n\t'https://github.com/edave64/Doki-Doki-Dialog-Generator/tree/master/public/assets/';\n\nconst listPaths: { [s: string]: string | undefined } = {\n\t'dddg.buildin.base.monika:ddlc.monika': `${baseUrl}monika`,\n\t'dddg.buildin.base.natsuki:ddlc.natsuki': `${baseUrl}natsuki`,\n\t'dddg.buildin.base.sayori:ddlc.sayori': `${baseUrl}sayori`,\n\t'dddg.buildin.base.yuri:ddlc.yuri': `${baseUrl}yuri`,\n\t'dddg.buildin.amy1:ddlc.fan.amy1': `${baseUrl}classic_amy`,\n\t'dddg.buildin.amy2:ddlc.fan.amy2': `${baseUrl}amy`,\n\t'dddg.buildin.femc:ddlc.fan.femc': `${baseUrl}femc`,\n\t'dddg.buildin.femc:ddlc.fan.femc:straight_lh': `${baseUrl}femc_lh`,\n\t'dddg.buildin.femc:ddlc.fan.femc:straight_hetero': `${baseUrl}femc/hetero`,\n\t'dddg.buildin.femc:ddlc.fan.femc:straight_hetero_lh': `${baseUrl}femc_lh/hetero`,\n\t'dddg.buildin.mc_classic:ddlc.fan.mc1': `${baseUrl}classic_mc`,\n\t'dddg.buildin.mc:ddlc.fan.mc2': `${baseUrl}mc`,\n\t'dddg.buildin.mc:ddlc.fan.mc2:straight_red': `${baseUrl}mc/red`,\n\t'dddg.buildin.mc_chad:ddlc.fan.mc_chad': `${baseUrl}chad`,\n\t'dddg.buildin.mc_chad:ddlc.fan.mc_chad:straight_red': `${baseUrl}chad/red`,\n};\n\nconst partFiles: { [s: string]: string[] | undefined } = {};\n\nconst charDefDefaults = {\n\ttype: 'character' as 'character',\n\tcharacterType: '',\n\tfreeMove: false,\n\tclose: false,\n\tstyleGroupId: 0,\n\tstyleId: 0,\n\tposeId: 0,\n\tposePositions: {},\n\tpanelId: '',\n\tid: '',\n\ty: 0,\n\trotation: 0,\n\tpreserveRatio: true,\n\tratio: 1,\n\topacity: 100,\n\tversion: 1,\n\tflip: false,\n\tonTop: false,\n\tcomposite: 'source-over' as 'source-over',\n\tfilters: [],\n};\n\nexport default defineComponent({\n\tmixins: [VerticalScrollRedirect],\n\tcomponents: { Selection, Selector, ToggleBox, DropTarget, DFieldset, L },\n\tprops: {\n\t\tcharacter: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tinitHeadGroup: String,\n\t},\n\tdata: () => ({\n\t\tmethod: 'upload' as null | 'upload' | 'parts',\n\t\theadGroup: null as null | IHeadGroup,\n\t\tuploadsFinished: false,\n\t\teverythingBroken: false,\n\t\tuploadedExpressions: [] as string[],\n\t\tcurrentUploadedExpression: null as string | null,\n\t\tpreviewPoseIdx: 0,\n\t\toffsetX: 0,\n\t\toffsetY: 0,\n\t\taddMask: false,\n\t\taddExtras: false,\n\t\tbatchRunner: null! as WorkBatch<string, string>,\n\t}),\n\tcreated() {\n\t\t(window as any).exp = this;\n\t\tthis.batchRunner = new WorkBatch<string, string>(\n\t\t\tthis.processExpression.bind(this),\n\t\t\tasync () => {}\n\t\t);\n\t\tif (this.initHeadGroup) {\n\t\t\tthis.headGroup = this.availableHeadGroups.find(\n\t\t\t\tgroup => group.name === this.initHeadGroup\n\t\t\t)!;\n\t\t}\n\t\tthis.applySingleHeadGroup();\n\t},\n\twatch: {\n\t\tavailableHeadGroups() {\n\t\t\tthis.applySingleHeadGroup();\n\t\t},\n\t\tpreviewPoseIdx() {\n\t\t\tthis.redraw();\n\t\t},\n\t\tpreviewPoses() {\n\t\t\tthis.redraw();\n\t\t},\n\t\tcurrentUploadedExpression() {\n\t\t\tthis.redraw();\n\t\t},\n\t\toffsetX() {\n\t\t\tthis.redraw();\n\t\t},\n\t\toffsetY() {\n\t\t\tthis.redraw();\n\t\t},\n\t\taddMask() {\n\t\t\tthis.redraw();\n\t\t},\n\t\taddExtras() {\n\t\t\tthis.redraw();\n\t\t},\n\t},\n\tmethods: {\n\t\tapplySingleHeadGroup() {\n\t\t\tif (this.availableHeadGroups.length === 1) {\n\t\t\t\tthis.headGroup = this.availableHeadGroups[0];\n\t\t\t}\n\t\t},\n\n\t\tasync addByUpload(): Promise<void> {\n\t\t\tconst uploadInput = this.$refs.upload as HTMLInputElement;\n\t\t\tif (!uploadInput.files) return;\n\t\t\tfor (const file of uploadInput.files) {\n\t\t\t\tthis.addByImageFile(file);\n\t\t\t}\n\t\t},\n\n\t\taddByImageFile(file: File) {\n\t\t\tconst url = URL.createObjectURL(file);\n\t\t\tthis.addUrl(url);\n\t\t},\n\n\t\tasync addByUrl(): Promise<void> {\n\t\t\tconst url = await environment.prompt('Enter the url of the image.', '');\n\t\t\tif (!url) return;\n\t\t\tthis.addUrl(url);\n\t\t},\n\n\t\taddUrl(url: string): void {\n\t\t\tthis.currentUploadedExpression = url;\n\t\t\tthis.uploadedExpressions.push(url);\n\t\t},\n\n\t\tasync processExpression(\n\t\t\texpression: string,\n\t\t\tisRunning: () => boolean\n\t\t): Promise<string | undefined> {\n\t\t\tconst asset = (await getAssetByUrl(expression)) as HTMLImageElement;\n\t\t\tif (!isRunning()) return undefined;\n\t\t\tconst renderer = new Renderer(\n\t\t\t\tasset.width + this.offsetX,\n\t\t\t\tasset.height + this.offsetY\n\t\t\t);\n\t\t\tconst blob = await renderer.renderToBlob(async rx => {\n\t\t\t\trx.drawImage({\n\t\t\t\t\timage: asset,\n\t\t\t\t\tx: this.offsetX,\n\t\t\t\t\ty: this.offsetY,\n\t\t\t\t\tw: asset.width,\n\t\t\t\t\th: asset.height,\n\t\t\t\t});\n\n\t\t\t\tif (\n\t\t\t\t\tthis.addMask &&\n\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\tthis.headGroup.imagePatching.mask\n\t\t\t\t) {\n\t\t\t\t\tconst mask = (await getAssetByUrl(\n\t\t\t\t\t\tthis.headGroup.imagePatching.mask\n\t\t\t\t\t)) as HTMLImageElement;\n\t\t\t\t\tif (!isRunning()) return undefined;\n\t\t\t\t\trx.drawImage({\n\t\t\t\t\t\timage: mask,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\tw: mask.width,\n\t\t\t\t\t\th: mask.height,\n\t\t\t\t\t\tcomposite: 'destination-in',\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\tthis.addExtras &&\n\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\tthis.headGroup.imagePatching.addition\n\t\t\t\t) {\n\t\t\t\t\tconst addition = (await getAssetByUrl(\n\t\t\t\t\t\tthis.headGroup.imagePatching.addition\n\t\t\t\t\t)) as HTMLImageElement;\n\t\t\t\t\tif (!isRunning()) return undefined;\n\t\t\t\t\trx.drawImage({\n\t\t\t\t\t\timage: addition,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\tw: addition.width,\n\t\t\t\t\t\th: addition.height,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\tconst finalExpression = URL.createObjectURL(blob);\n\n\t\t\tif (expression !== finalExpression && expression.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(expression);\n\t\t\t}\n\n\t\t\treturn finalExpression;\n\t\t},\n\n\t\tasync redraw() {\n\t\t\tif (this.uploadsFinished) return;\n\t\t\tconst pose = this.previewPoses[this.previewPoseIdx];\n\t\t\tif (!pose) return;\n\t\t\tlet charRenderer: Character;\n\t\t\ttry {\n\t\t\t\tcharRenderer = new Character(\n\t\t\t\t\t{\n\t\t\t\t\t\t...charDefDefaults,\n\t\t\t\t\t\twidth: pose.width,\n\t\t\t\t\t\theight: pose.height,\n\t\t\t\t\t\tposeId: this.previewPoseIdx,\n\t\t\t\t\t\tx: pose.width / 2,\n\t\t\t\t\t\tposePositions: {\n\t\t\t\t\t\t\theadGroup: 0,\n\t\t\t\t\t\t\thead: this.uploadedExpressions.indexOf(\n\t\t\t\t\t\t\t\tthis.currentUploadedExpression!\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlabel: null,\n\t\t\t\t\t\ttextboxColor: null,\n\t\t\t\t\t\tenlargeWhenTalking: false,\n\t\t\t\t\t\tnameboxWidth: null,\n\t\t\t\t\t\tzoom: 1,\n\t\t\t\t\t},\n\t\t\t\t\tawait this.temporaryCharacterModel\n\t\t\t\t);\n\t\t\t} catch (e) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$nextTick(async () => {\n\t\t\t\tif (this.uploadsFinished) return;\n\t\t\t\tconst renderer = new Renderer(pose.width, pose.height);\n\t\t\t\tawait renderer.render(async rx => {\n\t\t\t\t\tawait charRenderer.render(false, rx);\n\t\t\t\t});\n\n\t\t\t\tconst target = this.$refs.target as HTMLCanvasElement;\n\t\t\t\tconst ctx = target.getContext('2d')!;\n\t\t\t\tctx.clearRect(0, 0, target.width, target.height);\n\t\t\t\trenderer.paintOnto(ctx, {\n\t\t\t\t\tx: 0,\n\t\t\t\t\ty: 0,\n\t\t\t\t\tw: target.width,\n\t\t\t\t\th: target.height,\n\t\t\t\t});\n\t\t\t});\n\t\t},\n\n\t\tasync finishUpload() {\n\t\t\tthis.uploadsFinished = true;\n\t\t\tconst processedExpressions = (\n\t\t\t\tawait this.batchRunner.run(this.uploadedExpressions)\n\t\t\t).filter(exp => exp) as string[];\n\n\t\t\tconst storeCharacter = this.$store.state.content.current.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t)!;\n\t\t\tlet character = uploadedExpressionsPack.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t);\n\t\t\tif (!character) {\n\t\t\t\tcharacter = {\n\t\t\t\t\tid: this.character,\n\t\t\t\t\theads: {},\n\t\t\t\t\tstyleGroups: [],\n\t\t\t\t\tlabel: '',\n\t\t\t\t\tchibi: '',\n\t\t\t\t\tsize: [960, 960],\n\t\t\t\t\tdefaultScale: [0.8, 0.8],\n\t\t\t\t\thd: false,\n\t\t\t\t} as CharacterModel<string>;\n\t\t\t\tuploadedExpressionsPack.characters.push(character);\n\t\t\t}\n\n\t\t\tlet headGroup = character.heads[this.headGroup!.name];\n\t\t\tconst storeHeadGroup = storeCharacter.heads[this.headGroup!.name];\n\t\t\tif (!headGroup) {\n\t\t\t\theadGroup = {\n\t\t\t\t\tpreviewSize: storeHeadGroup.previewSize as any,\n\t\t\t\t\tpreviewOffset: storeHeadGroup.previewOffset as any,\n\t\t\t\t\tvariants: [],\n\t\t\t\t};\n\t\t\t\tcharacter.heads[this.headGroup!.name] = headGroup;\n\t\t\t}\n\n\t\t\tfor (const processedExpression of processedExpressions) {\n\t\t\t\theadGroup.variants.push([processedExpression]);\n\t\t\t}\n\n\t\t\tawait this.vuexHistory.transaction(() => {\n\t\t\t\tthis.$store.dispatch('content/replaceContentPack', {\n\t\t\t\t\tcontentPack: uploadedExpressionsPack,\n\t\t\t\t} as ReplaceContentPackAction);\n\t\t\t});\n\n\t\t\tthis.leave();\n\t\t},\n\n\t\tleave() {\n\t\t\tthis.$emit('leave');\n\t\t\tthis.method = null;\n\t\t\tthis.headGroup = null;\n\t\t\tthis.uploadedExpressions = [];\n\t\t},\n\n\t\tremoveUploadedExpression() {\n\t\t\tif (!this.currentUploadedExpression) return;\n\t\t\tconst expression = this.currentUploadedExpression;\n\t\t\tthis.currentUploadedExpression = null;\n\t\t\tif (expression.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(expression);\n\t\t\t}\n\t\t\tlet idx = this.uploadedExpressions.indexOf(expression);\n\t\t\tthis.uploadedExpressions.splice(idx, 1);\n\t\t\tif (idx > this.uploadedExpressions.length - 1) {\n\t\t\t\tidx = this.uploadedExpressions.length - 1;\n\t\t\t}\n\t\t\tthis.currentUploadedExpression = this.uploadedExpressions[idx] || null;\n\t\t},\n\n\t\tnormalizeName(name: string): string {\n\t\t\tconst parts = name.split(':');\n\t\t\tlet actualName = parts[parts.length - 1];\n\t\t\tconst packId = parts.length > 1 ? parts[0].trim() : '';\n\n\t\t\tactualName = (\n\t\t\t\tactualName[0].toUpperCase() + actualName.slice(1).toLowerCase()\n\t\t\t)\n\t\t\t\t.split('_')\n\t\t\t\t.join(' ');\n\t\t\tif (packId.startsWith('dddg.') || packId === '') {\n\t\t\t\treturn actualName;\n\t\t\t}\n\t\t\treturn packId + ': ' + actualName;\n\t\t},\n\n\t\tdragEnter(e: DragEvent) {\n\t\t\tif (!this.headGroup || this.method !== 'upload') return;\n\t\t\tif (!e.dataTransfer) return;\n\t\t\te.dataTransfer.effectAllowed = 'none';\n\t\t\tif (\n\t\t\t\t!Array.from(e.dataTransfer.items).find(item =>\n\t\t\t\t\titem.type.match(/^image.*$/)\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\te.dataTransfer.effectAllowed = 'link';\n\t\t\t(this.$refs.dt as any).show();\n\t\t},\n\n\t\thideDt() {\n\t\t\tif (this.$refs.dt) (this.$refs.dt as any).hide();\n\t\t},\n\t},\n\tcomputed: {\n\t\tcharacterData(): DeepReadonly<CharacterModel<IAsset>> {\n\t\t\treturn this.$store.state.content.current.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t)!;\n\t\t},\n\n\t\tavailableHeadGroups(): IHeadGroup[] {\n\t\t\tconst characterData = this.characterData;\n\t\t\tconst headTypes = Object.keys(characterData.heads);\n\t\t\treturn headTypes.map(headTypeKey => {\n\t\t\t\tconst headType = characterData.heads[headTypeKey];\n\n\t\t\t\treturn {\n\t\t\t\t\tname: headTypeKey,\n\t\t\t\t\tpreview: headType.variants[0].map(asset => asset.lq),\n\t\t\t\t\tpartsFiles: partFiles[headTypeKey] || [],\n\t\t\t\t\timagePatching: {\n\t\t\t\t\t\tmask: masks[headTypeKey],\n\t\t\t\t\t\taddition: adds[headTypeKey],\n\t\t\t\t\t},\n\t\t\t\t} as IHeadGroup;\n\t\t\t});\n\t\t},\n\n\t\thasParts(): boolean {\n\t\t\treturn !!this.availableHeadGroups.find(\n\t\t\t\theadGroup => headGroup.partsFiles.length > 0\n\t\t\t);\n\t\t},\n\n\t\tdownloadLink(): string | null {\n\t\t\tconst character = this.characterData;\n\t\t\tif (!character || !this.headGroup) return null;\n\t\t\tconst headType = character.heads[this.headGroup!.name];\n\t\t\tif (!headType) return null;\n\t\t\treturn headType.variants[0][0].hq;\n\t\t},\n\n\t\tlistLink(): string | null {\n\t\t\tif (!this.characterData || !this.headGroup) return null;\n\t\t\tconst charName = this.characterData.id;\n\t\t\tconst headGroupName = this.headGroup.name;\n\t\t\tif (listPaths[charName + ':' + headGroupName]) {\n\t\t\t\treturn listPaths[charName + ':' + headGroupName] || null;\n\t\t\t}\n\t\t\treturn listPaths[charName] || null;\n\t\t},\n\n\t\tpreviewPoses(): IPose[] {\n\t\t\tconst character = this.characterData;\n\t\t\tif (!character || !this.headGroup) return [];\n\t\t\tconst poses: IPose[] = [];\n\n\t\t\tfor (\n\t\t\t\tlet styleGroupIdx = 0;\n\t\t\t\tstyleGroupIdx < character.styleGroups.length;\n\t\t\t\t++styleGroupIdx\n\t\t\t) {\n\t\t\t\tconst styleGroup = character.styleGroups[styleGroupIdx];\n\t\t\t\tfor (\n\t\t\t\t\tlet styleIdx = 0;\n\t\t\t\t\tstyleIdx < styleGroup.styles.length;\n\t\t\t\t\t++styleIdx\n\t\t\t\t) {\n\t\t\t\t\tconst style = styleGroup.styles[styleIdx];\n\t\t\t\t\tfor (let poseIdx = 0; poseIdx < style.poses.length; ++poseIdx) {\n\t\t\t\t\t\tconst pose = style.poses[poseIdx];\n\t\t\t\t\t\tif (pose.compatibleHeads.includes(this.headGroup.name)) {\n\t\t\t\t\t\t\tposes.push({\n\t\t\t\t\t\t\t\tname: pose.id,\n\t\t\t\t\t\t\t\tstyleGroupId: styleGroupIdx,\n\t\t\t\t\t\t\t\tstyleId: styleIdx,\n\t\t\t\t\t\t\t\tposeId: poseIdx,\n\t\t\t\t\t\t\t\twidth: pose.size[0],\n\t\t\t\t\t\t\t\theight: pose.size[1],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn poses;\n\t\t},\n\n\t\texpressionModels(): IAsset[][] {\n\t\t\treturn this.uploadedExpressions.map(expression => [\n\t\t\t\t{\n\t\t\t\t\thq: expression,\n\t\t\t\t\tlq: expression,\n\t\t\t\t\tsourcePack: 'dddg.temp1:default',\n\t\t\t\t} as IAsset,\n\t\t\t]);\n\t\t},\n\n\t\ttemporaryCharacterModel(): CharacterModel<IAsset> {\n\t\t\tconst poses = this.previewPoses;\n\t\t\tconst character = this.$store.state.content.current.characters.find(\n\t\t\t\tchar => char.id === this.character\n\t\t\t)!;\n\t\t\tconst offsetX = this.offsetX;\n\t\t\tconst offsetY = this.offsetY;\n\n\t\t\treturn {\n\t\t\t\tid: this.character,\n\t\t\t\tsize: [960, 960],\n\t\t\t\tdefaultScale: [0.8, 0.8],\n\t\t\t\thd: false,\n\t\t\t\theads: {\n\t\t\t\t\t'dddg.temp1:default': {\n\t\t\t\t\t\tvariants: this.expressionModels,\n\t\t\t\t\t\tpreviewSize: [0, 0],\n\t\t\t\t\t\tpreviewOffset: [0, 0],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tstyleGroups: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'preview',\n\t\t\t\t\t\tstyleComponents: [],\n\t\t\t\t\t\tstyles: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcomponents: {},\n\t\t\t\t\t\t\t\tposes: poses.map((pose, idx) => {\n\t\t\t\t\t\t\t\t\tconst styleGroup = character.styleGroups[pose.styleGroupId];\n\t\t\t\t\t\t\t\t\tconst style = styleGroup.styles[pose.styleId];\n\t\t\t\t\t\t\t\t\tconst renderCommands = style.poses[\n\t\t\t\t\t\t\t\t\t\tpose.poseId\n\t\t\t\t\t\t\t\t\t].renderCommands.slice(0);\n\t\t\t\t\t\t\t\t\tlet headIdx = renderCommands.findIndex(\n\t\t\t\t\t\t\t\t\t\tcommand => command.type === 'head'\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tconst headRenderCommand = renderCommands[headIdx];\n\t\t\t\t\t\t\t\t\tconst newHeadCommand: IHeadCommand = {\n\t\t\t\t\t\t\t\t\t\ttype: 'head',\n\t\t\t\t\t\t\t\t\t\toffset: [\n\t\t\t\t\t\t\t\t\t\t\theadRenderCommand.offset[0] + offsetX,\n\t\t\t\t\t\t\t\t\t\t\theadRenderCommand.offset[1] + offsetY,\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\tthis.addMask &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching.mask\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\tconst mask = this.headGroup.imagePatching.mask;\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(headIdx, 1);\n\t\t\t\t\t\t\t\t\t\theadIdx = 1;\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(0, 0, newHeadCommand, {\n\t\t\t\t\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\t\t\t\t\timages: [\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\thq: mask,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlq: mask,\n\t\t\t\t\t\t\t\t\t\t\t\t\tsourcePack: 'dddg.temp1',\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\tcomposite: 'destination-in',\n\t\t\t\t\t\t\t\t\t\t\toffset: headRenderCommand.offset,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(headIdx, 1, newHeadCommand);\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\tthis.addExtras &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching &&\n\t\t\t\t\t\t\t\t\t\tthis.headGroup.imagePatching.addition\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\tconst add = this.headGroup.imagePatching.addition;\n\t\t\t\t\t\t\t\t\t\trenderCommands.splice(headIdx + 1, 0, {\n\t\t\t\t\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\t\t\t\t\timages: [\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\thq: add,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlq: add,\n\t\t\t\t\t\t\t\t\t\t\t\t\tsourcePack: 'dddg.temp1',\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\toffset: headRenderCommand.offset,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t...style.poses[pose.poseId],\n\t\t\t\t\t\t\t\t\t\trenderCommands,\n\t\t\t\t\t\t\t\t\t\tid: 'dddg.temp1:pose' + idx,\n\t\t\t\t\t\t\t\t\t\tcompatibleHeads: ['dddg.temp1:default'],\n\t\t\t\t\t\t\t\t\t} as Pose<IAsset>;\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tlabel: '',\n\t\t\t\tchibi: null!,\n\t\t\t};\n\t\t},\n\t},\n});\n\ninterface IPose {\n\tname: string;\n\tstyleGroupId: number;\n\tstyleId: number;\n\tposeId: number;\n\twidth: number;\n\theight: number;\n}\n\ninterface IHeadGroup {\n\tname: string;\n\tpreview: string[];\n\tpartsFiles: string[];\n\timagePatching?: {\n\t\tmask?: string;\n\t\taddition?: string;\n\t};\n}\n\ninterface ICachedProcessedExpression {\n\turl: string;\n\taddMask: boolean;\n\taddExtras: boolean;\n\toffsetX: number;\n\toffsetY: number;\n}\n","import { render } from \"./index.vue?vue&type=template&id=123a5ebc&scoped=true\"\nimport script from \"./index.vue?vue&type=script&lang=ts\"\nexport * from \"./index.vue?vue&type=script&lang=ts\"\n\nimport \"./index.vue?vue&type=style&index=0&id=123a5ebc&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-123a5ebc\"\n\nexport default script"],"sourceRoot":""}